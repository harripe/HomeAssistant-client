##################################
# Pörssäri Home Assistant client #
##################################

# This file includes core functionalities. Do not edit this file.
# Add "Pörssäri laitetunnus" via Settings --> Devices & Services --> Helpers

# JSON-request from server
rest:
  - resource_template: >
      {% set MAC = states('input_text.porssari_mac') if states('input_text.porssari_mac') | length > 10 else "HA_undefined" %} 
      {% if state_attr("sensor.porssari_json_data", "metadata") %}
        {% set timestamp = state_attr("sensor.porssari_json_data", "metadata")['timestamp'] %}
        {% set fetch_url = state_attr("sensor.porssari_json_data", "metadata")['fetch_url'] %}
      {% else %}
        {% set timestamp = 0 %}
        {% set fetch_url = "https://api.porssari.fi/getcontrols.php" %}
      {% endif %}
      {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_2.0&json_version=2
    scan_interval: 604800
    sensor:
      - name: "porssari_json"
        value_template: "{{ value_json.metadata.timestamp|default(0) }}"
        json_attributes:
          - metadata
          - controls

# Is updated -state request from server
command_line:
  - sensor:
      name: "porssari_request"
      command: >-
        curl -o /dev/null -qsI -w "%{http_code}\n" "
        {%- set MAC = states("input_text.porssari_mac")|default("HA_undefined") -%}
        {%- set timestamp = state_attr("sensor.porssari_json_data", "metadata")["timestamp"]|default("0") -%}
        {%- set fetch_url = state_attr("sensor.porssari_json_data", "metadata")["fetch_url"]|default("https://api.porssari.fi/getcontrols.php") -%}
        {{ fetch_url }}?device_mac={{ MAC }}&last_request={{ timestamp }}&client=Homeassistant_2.0&headers=true"
      scan_interval: 604800
      value_template: "{{ value }}"

template:
  # Sensors for Channel states.
  - sensor:
      - name: "porssari_channel_1_state"
        unique_id: porssari_ch1_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '1' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 2 State"
        unique_id: porssari_ch2_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '2' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 3 State"
        unique_id: porssari_ch3_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '3' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 4 State"
        unique_id: porssari_ch4_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '4' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 5 State"
        unique_id: porssari_ch5_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '5' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 6 State"
        unique_id: porssari_ch6_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '6' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 7 State"
        unique_id: porssari_ch7_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '7' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 8 State"
        unique_id: porssari_ch8_state
        state: >
          {% if is_state('binary_sensor.porssari_json_controls', 'on') %}
            {% set ns = namespace(state=-1) %}
            {% for item in state_attr("sensor.porssari_json_data", "controls") %}
              {% if item.id == '8' %}
                {% set ns.state = item.state %}
                {% for schedule in item.schedules %}
                  {% if as_datetime(schedule.timestamp) < now() %}
                    {% set ns.state = schedule.state %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ ns.state }}
          {% else %}
            {{ -1 }}
          {% endif %}
      - name: "Pörssäri Channel 1 on hours"
        unique_id: porssari_ch1_on_hours
        state: >
          {% set ch = '1' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 2 on hours"
        unique_id: porssari_ch2_on_hours
        state: >
          {% set ch = '2' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 3 on hours"
        unique_id: porssari_ch3_on_hours
        state: >
          {% set ch = '3' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 4 on hours"
        unique_id: porssari_ch4_on_hours
        state: >
          {% set ch = '4' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 5 on hours"
        unique_id: porssari_ch5_on_hours
        state: >
          {% set ch = '5' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 6 on hours"
        unique_id: porssari_ch6_on_hours
        state: >
          {% set ch = '6' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 7 on hours"
        unique_id: porssari_ch7_on_hours
        state: >
          {% set ch = '7' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}
      - name: "Pörssäri Channel 8 on hours"
        unique_id: porssari_ch8_on_hours
        state: >
          {% set ch = '8' %}
          {% set controls = state_attr('sensor.porssari_json_data', 'controls') %}

          {% if not controls %}
            JSON-data ei saatavilla
          {% else %}
            {% set channel = controls | selectattr('id','equalto',ch) | first %}
            {% if not channel %}
              Id: {{ ch }} ei löydy
            {% elif not channel.schedules %}
              Ei ajastuksia
            {% else %}

              {% set sorted = channel.schedules | sort(attribute='timestamp') %}

              {% for s in sorted[:4] %}
                {% set t = s.timestamp | int %}
                {% if (t % 900) >= 450 %}
                  {% set r = ((t // 900) + 1) * 900 %}
                {% else %}
                  {% set r = (t // 900) * 900 %}
                {% endif %}

                {% if s.state == '1' %}
                  {{ r | timestamp_custom('%H:%M') }}
                {% elif s.state == '0' %}
                  {{ '−' ~ (r | timestamp_custom('%H:%M,')) }}
                {% endif %}
                {% if not loop.last %} {% endif %}
              {% endfor %}

            {% endif %}
          {% endif %}

  # Sensor to save request json data.
  - sensor:
      - name: porssari_json_data
        state: >
          {% if state_attr("sensor.porssari_json_data", "metadata") %}
            {{ state_attr("sensor.porssari_json_data", "metadata")['timestamp'] }}
          {% else %}
            {{ 0 }}
          {% endif %}
        attributes:
          metadata: >
            {{ state_attr("sensor.porssari_json", "metadata") if state_attr("sensor.porssari_json", "metadata") else state_attr("sensor.porssari_json_data", "metadata") }}
          controls: >
            {{ state_attr("sensor.porssari_json", "controls") if state_attr("sensor.porssari_json", "controls") else state_attr("sensor.porssari_json_data", "controls") }}

  # Sensor to determine if json is valid for controls
  - binary_sensor:
      - name: porssari_json_controls
        state: >
          {% if state_attr("sensor.porssari_json_data", "metadata") %}
            {% set validUntil = as_datetime(state_attr("sensor.porssari_json_data", "metadata")['valid_until'] | int).timestamp() %}
            {% set timestampNow = utcnow().timestamp() %}
            {{ timestampNow < validUntil }}
          {% else %}
            {{ false }}
          {% endif %}



# Update logic for json-sensor.
automation:
  - id: "porssari_update_automation"
    alias: porssari_update_json
    description: "Uusi ohjaustieto haetaan kun asetuksia on päivitetty tai tunnin välein"
    trigger:
      - platform: time_pattern
        minutes: /5
      - platform: homeassistant
        event: start
    action:
      - delay: "{{ range(30) | random }}"
      - service: homeassistant.update_entity
        alias: update_porssari_request
        target:
          entity_id: sensor.porssari_request
      - if:
          - condition: state
            entity_id: sensor.porssari_request
            state: "200"
        then:
          - delay: 12
          - service: homeassistant.update_entity
            alias: update_porssari_json
            target:
              entity_id: sensor.porssari_json
    mode: single

# Settings parameters
input_text:
  porssari_mac:
    name: Pörssäri laitetunnus
